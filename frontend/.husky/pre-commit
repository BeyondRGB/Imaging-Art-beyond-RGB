ERROR_MSG=""
NEEDS_FORMATTING=0

# Get staged C/C++ files
FILES=$(git diff --cached --name-only --diff-filter=ACM \
    -- '*.cpp' '*.cxx' '*.h' '*.hh' '*.hpp' '*.hxx')

# Format backend files if needed
if [ -z "$FILES" ]; then
    NEEDS_FORMATTING=0
else
    for file in $FILES; do
        tmp=$(mktemp)

        # Make sure tmp file is deleted there's an unexcepted exit
        trap 'rm -f "$tmp"' EXIT HUP INT TERM

        # Compare staged file and formatter output
        if ! clang-format -style=file -assume-filename="$file" "$tmp" \
            | diff -q "$tmp" - >/dev/null
        then
            NEEDS_FORMATTING=1
            ERROR_MSG="Backend file not formatted: "$file". Applying clang-format to invalid file."
            clang-format -style=file -i "$file"
        fi

        rm -f "$tmp"
    done
fi

cd frontend

# Get staged frontend files
FILES=$(git diff --cached --name-only --diff-filter=ACM \
    -- '*.html' '*.svelte' '*.css' '*.ts' '*.js' '*.json')

# Check format of staged frontend files
if ! [ -z "$FILES" ]; then
    for file in $FILES; do
        if ! npx prettier --check --loglevel=silent ../$file; then
            NEEDS_FORMATTING=1
            ERROR_MSG="$ERROR_MSG Frontend file(s) not formatted. Please run ""npm run format"" to format frontend files."
            break
        fi
    done
fi

# Files are formatted
if [ "$NEEDS_FORMATTING" -eq 0 ]; then
    exit 0
fi

echo $ERROR_MSG
exit 1