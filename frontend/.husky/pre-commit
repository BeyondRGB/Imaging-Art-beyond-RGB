ERROR_MSG=""

# Get staged C/C++ files
FILES=$(git diff --cached --name-only --diff-filter=ACM \
    -- '*.cpp' '*.cxx' '*.h' '*.hh' '*.hpp' '*.hxx')

# Format backend files if needed
if [ -z "$FILES" ]; then
    NEEDS_FORMATTING=0
else
    for file in $FILES; do
        # Compare staged file and formatter output
        if ! git show ":$file" \
            | clang-format -style=file -assume-filename="$file" \
            | diff -q - <(git show ":$file") >/dev/null; then
            NEEDS_FORMATTING=1
            ERROR_MSG="Backend files not formatted. Applying clang-format to invalid files."
            # Format changed backend files
            clang-format -i -style=file $FILES
            break
        fi
    done
fi

cd frontend

# Get staged frontend files
FILES=$(git diff --cached --name-only --diff-filter=ACM \
    -- '*.html' '*.svelte' '*.css' '*.ts' '*.js' '*.json')

# Check format of staged frontend files
if ! [ -z "$FILES" ]; then
    for file in $FILES; do
        if ! npx prettier --check ../$file; then
            NEEDS_FORMATTING=1
            ERROR_MSG="$ERROR_MSG Frontend file not formatted: $file. Please run ""npm run format"" to format them."
            break
        fi
    done
fi

# Files are formatted
if [ "$NEEDS_FORMATTING" -eq 0 ]; then
    exit 0
fi

echo $ERROR_MSG
exit 1

