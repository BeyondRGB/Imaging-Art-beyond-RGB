set -e

# Get staged C/C++ files
FILES=$(git diff --cached --name-only --diff-filter=ACM \
    -- '*.cpp' '*.cxx' '*.h' '*.hh' '*.hpp' '*.hxx')

[ -z "$FILES" ] && exit 0

NEEDS_FORMATTING=0

for file in $FILES; do
	# Compare staged file and formatter output
    if ! git show ":$file" \
        | clang-format -style=file -assume-filename="$file" \
        | diff -q - <(git show ":$file") >/dev/null; then
        NEEDS_FORMATTING=1
        break
    fi
done


# Files are formatted
if [ "$NEEDS_FORMATTING" -eq 0 ]; then
    exit 0
fi

echo "Backend files not formatted. Applying clang-format to invalid files. Stage formatted files and try again."

# Format changed backend files
clang-format -i -style=file $FILES

exit 1

