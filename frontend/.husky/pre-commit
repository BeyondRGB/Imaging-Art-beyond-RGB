ERROR_MSG=""
NEEDS_FORMATTING=0

# Get staged C/C++ files
FILES=$(git diff --cached --name-only --diff-filter=ACM \
    -- '*.cpp' '*.cxx' '*.h' '*.hh' '*.hpp' '*.hxx')

# Format backend files if needed
if [ -z "$FILES" ]; then
    NEEDS_FORMATTING=0
else
    for file in $FILES; do
        # Compare staged file and formatter output
        tmp1=$(mktemp)
        tmp2=$(mktemp)

        git show ":$file" > "$tmp1"
        clang-format -style=file -assume-filename="$file" "$tmp1" > "$tmp2"

        if ! diff -q "$tmp1" "$tmp2" >/dev/null; then
            echo "Formatting differs"
        fi

        rm -f "$tmp1" "$tmp2"
    done
fi

cd frontend

# Get staged frontend files
FILES=$(git diff --cached --name-only --diff-filter=ACM \
    -- '*.html' '*.svelte' '*.css' '*.ts' '*.js' '*.json')

# Check format of staged frontend files
if ! [ -z "$FILES" ]; then
    for file in $FILES; do
        if ! npx prettier --check ../$file; then
            NEEDS_FORMATTING=1
            ERROR_MSG="$ERROR_MSG Frontend file not formatted: $file. Please run ""npm run format"" to format them."
            break
        fi
    done
fi

# Files are formatted
if [ "$NEEDS_FORMATTING" -eq 0 ]; then
    exit 0
fi

echo $ERROR_MSG
exit 1

