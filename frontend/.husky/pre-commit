# Check for formatted backend files

# Get staged C/C++ files
BACKEND_FILES=$(git diff --cached --name-only --diff-filter=ACM \
    -- '*.cpp' '*.cxx' '*.h' '*.hh' '*.hpp' '*.hxx')

[ -z "$BACKEND_FILES" ] && exit 0

for file in $BACKEND_FILES; do
	# Compare staged file and formatter output
    if ! git show ":$file" \
        | clang-format -style=file -assume-filename="$file" \
        | diff -q - <(git show ":$file") >/dev/null; then
        echo "Backend files not formatted. Applying clang-format to invalid files. Stage formatted files and try again."

        # Format changed backend files
        clang-format -i -style=file $BACKEND_FILES

        exit 1
    fi
done

# Check changed frontend files for valid format
FRONTEND_FILES=$(git diff --cached --name-only --diff-filter=ACM \
    -- '*.html' '*.js' '*.ts' '*.json' '*.svelte' '*.css')

# Exit early if no relevant files
if [ -z "$FILES" ]; then
  exit 0
fi

# Check if there's any unformatted files
if ! npx prettier --check $FILES; then
  echo "Frontend files are not formatted correctly. Please run 'npm run format' to fix them."
  exit 1
fi

exit 1

